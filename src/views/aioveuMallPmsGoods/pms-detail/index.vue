<template>
  <div class="app-container">

    <!-- æ­¥éª¤æ¡ï¼šæ˜¾ç¤ºå•†å“åˆ›å»º/ç¼–è¾‘çš„æ­¥éª¤æµç¨‹ -->
        <el-steps
          :active="activeStep"
          process-status="finish"
          finish-status="success"
          simple
          class="goods-steps"
        >
          <!-- æ­¥éª¤1ï¼šé€‰æ‹©å•†å“åˆ†ç±» -->
          <el-step title="é€‰æ‹©å•†å“åˆ†ç±»" description="é€‰æ‹©å•†å“æ‰€å±çš„åˆ†ç±»" />
          <!-- æ­¥éª¤2ï¼šå¡«å†™å•†å“ä¿¡æ¯ -->
          <el-step title="å¡«å†™å•†å“ä¿¡æ¯" description="å¡«å†™å•†å“åŸºæœ¬ä¿¡æ¯" />
          <!-- æ­¥éª¤3ï¼šè®¾ç½®å•†å“å±æ€§ -->
          <el-step title="è®¾ç½®å•†å“å±æ€§" description="è®¾ç½®å•†å“è§„æ ¼å±æ€§" />
          <!-- æ­¥éª¤4ï¼šè®¾ç½®å•†å“åº“å­˜ -->
          <el-step title="è®¾ç½®å•†å“åº“å­˜" description="è®¾ç½®å•†å“SKUå’Œåº“å­˜" />
        </el-steps>

    <!-- æ­¥éª¤1ï¼šå•†å“åˆ†ç±»é€‰æ‹©ç»„ä»¶ -->
    <!-- é€šè¿‡ v-show æ§åˆ¶æ˜¾ç¤ºï¼Œv-if æ§åˆ¶æ¸²æŸ“ -->
    <!-- å•†å“åˆ†ç±»é€‰æ‹©ç»„ä»¶ï¼ˆç¼–è¾‘æ¨¡å¼éœ€è¦å›æ˜¾ï¼‰ -->
    <!-- ç›‘å¬ç¼–è¾‘äº‹ä»¶ -->
    <!--    ä½¿ç”¨ v-ifé…åˆ activeStepæ¡ä»¶ï¼Œç¡®ä¿æ¯æ¬¡åªæ¸²æŸ“ä¸€ä¸ªå­ç»„ä»¶-->
        <GoodsCategory
          v-if="activeStep === 0"
          v-model="goodsInfo"
          @prev="handlePrevStep"
          @next="handleNextStep"
          @edit-goods="handleEditGoods"
        />

    <!-- æ­¥éª¤2ï¼šå•†å“ä¿¡æ¯å¡«å†™ç»„ä»¶ -->
    <!-- å•†å“ä¿¡æ¯å¡«å†™ç»„ä»¶ï¼ˆç¼–è¾‘æ¨¡å¼éœ€è¦å›æ˜¾ï¼‰ -->
        <GoodsInfo
          v-if="activeStep === 1"
          v-model="goodsInfo"
          @prev="handlePrevStep"
          @next="handleNextStep"
        />

    <!-- æ­¥éª¤3ï¼šå•†å“å±æ€§è®¾ç½®ç»„ä»¶ -->
    <!-- å•†å“å±æ€§è®¾ç½®ç»„ä»¶ï¼ˆç¼–è¾‘æ¨¡å¼éœ€è¦å›æ˜¾ï¼‰ -->
        <GoodsAttribute
          v-if="activeStep === 2"
          v-model="goodsInfo"
          @prev="handlePrevStep"
          @next="handleNextStep"
        />

    <!-- æ­¥éª¤4ï¼šå•†å“åº“å­˜è®¾ç½®ç»„ä»¶ -->
    <!-- å•†å“åº“å­˜è®¾ç½®ç»„ä»¶ï¼ˆç¼–è¾‘æ¨¡å¼éœ€è¦å›æ˜¾ï¼‰ -->
        <GoodsStock
          v-if="activeStep === 3"
          v-model="goodsInfo"
          @prev="handlePrevStep"
          @next="handleNextStep"
        />

<!--   ===========================================  -->

  </div>
</template>

<script setup lang="ts">
defineOptions({
  name: "GoodsDetail",
  inheritAttrs: false,
});
import { ref, onMounted, watch, nextTick } from "vue";
import { useRoute, useRouter } from "vue-router";

// å¯¼å…¥å­ç»„ä»¶
// import GoodsCategory from "./components/GoodsCategory.vue";
// import GoodsInfo from "./components/GoodsInfo.vue";
// import GoodsAttribute from "./components/GoodsAttribute.vue";
// import GoodsStock from "./components/GoodsStock.vue";

// å¯¼å…¥APIæ¥å£
import PmsSpuAPI, {
  type PmsSpuPageVO
} from "@/api/aioveuMall/aioveuMallPms/aioveuMallPmsSpu/pms-spu";

// ==================== è·¯ç”±å’ŒçŠ¶æ€ç®¡ç† ====================
const route = useRoute();  // è·¯ç”±å®ä¾‹ï¼Œç”¨äºè·å–æŸ¥è¯¢å‚æ•°
const router = useRouter();  // è·¯ç”±å®ä¾‹ï¼Œç”¨äºé¡µé¢è·³è½¬
//
// // æ­¥éª¤çŠ¶æ€
const activeStep = ref<number>(0);  // å½“å‰æ¿€æ´»çš„æ­¥éª¤ï¼Œ0-3
const isDataLoaded = ref<boolean>(false);  // æ•°æ®æ˜¯å¦åŠ è½½å®Œæˆ


//çˆ¶ç»„ä»¶ä½¿ç”¨ PmsSpuPageVOç±»å‹
//
// å­ç»„ä»¶ä½¿ç”¨è‡ªå®šä¹‰çš„ GoodsInfoæ¥å£
//
// ä¸¤ä¸ªæ¥å£çš„ç»“æ„ä¸å®Œå…¨ä¸€è‡´
// å•†å“ä¿¡æ¯æ•°æ®
// æ”¹ä¸ºä½¿ç”¨ ref

// refçš„ .valueèµ‹å€¼åˆ›å»ºäº†å…¨æ–°çš„å¼•ç”¨ï¼ŒVue çš„å“åº”å¼ç³»ç»Ÿèƒ½æ›´å¯é åœ°è¿½è¸ªè¿™ç§å˜åŒ–ï¼Œç‰¹åˆ«æ˜¯åœ¨ç»„ä»¶é”€æ¯/é‡å»ºçš„åœºæ™¯ä¸‹ã€‚
//
// è€Œ reactiveçš„ Object.assignæ˜¯åŸåœ°ä¿®æ”¹ï¼Œåœ¨å¤æ‚çš„ç»„ä»¶ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå“åº”å¼è®¢é˜…å¯èƒ½ä¸¢å¤±ã€‚

const goodsInfo = ref<PmsSpuPageVO>({
  id: undefined,           // å•†å“ID
  name: "",                // å•†å“åç§°
  categoryId: undefined,   // åˆ†ç±»ID
  brandId: undefined,      // å“ç‰ŒID
  originPrice: undefined,  // åŸä»·ï¼ˆå•ä½ï¼šåˆ†ï¼‰
  price: undefined,        // ç°ä»·ï¼ˆå•ä½ï¼šåˆ†ï¼‰
  album: [],               // å•†å“ç›¸å†Œå›¾ç‰‡æ•°ç»„
  attrList: [],            // å•†å“å±æ€§åˆ—è¡¨
  specList: [],            // å•†å“è§„æ ¼åˆ—è¡¨
  skuList: [],             // å•†å“SKUåˆ—è¡¨
  detail: "",              // å•†å“è¯¦æƒ…HTML
  sales: 0,                // é”€é‡
  stock: 0,                // æ€»åº“å­˜
  picUrl: "",              // å•†å“ä¸»å›¾
  categoryName: "",        // åˆ†ç±»åç§°
  brandName: "",           // å“ç‰Œåç§°
});

// ==================== æ–¹æ³•å®šä¹‰ ====================
/**
 * åŠ è½½å•†å“æ•°æ®
 * å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œæ ¹æ®å•†å“IDåŠ è½½æ•°æ®   æ›´ç®€å•çš„æ–¹æ³•ï¼šåœ¨çˆ¶ç»„ä»¶ GoodsDetail.vueä¸­ç»Ÿä¸€åŠ è½½æ•°æ®ï¼Œç„¶åä¼ é€’ç»™æ‰€æœ‰å­ç»„ä»¶
 * å¦‚æœæ˜¯æ–°å¢æ¨¡å¼ï¼Œåªåˆå§‹åŒ–æ•°æ®
 */
const loadGoodsData = async (): Promise<void> => {
  try {
    const goodsId = goodsInfo.value.id;

    console.log("ğŸ“¦ åŠ è½½å•†å“æ•°æ®ï¼ŒID:", goodsId);

    if (goodsId) {
      console.log(`ğŸ“¦ ç¼–è¾‘æ¨¡å¼ï¼ŒåŠ è½½å•†å“ID: ${goodsId} çš„æ•°æ®`);

      // è°ƒç”¨APIè·å–å•†å“è¯¦æƒ…
      const response = await PmsSpuAPI.getSpuDetail(goodsId) as any;

      console.log(`ğŸ“¦ ç¼–è¾‘æ¨¡å¼ï¼ŒåŠ è½½å•†å“ä¿¡æ¯:{}`, response);

      if (response ) {

        // ç›´æ¥èµ‹å€¼
        goodsInfo.value = {
          ...response,
          // ä»·æ ¼è½¬æ¢
          originPrice: response.originPrice ? Number(response.originPrice) / 100 : undefined,
          price: response.price ? Number(response.price) / 100 : undefined
        };

        console.log("âœ… å•†å“æ•°æ®åŠ è½½å®Œæˆ", goodsInfo);

      }
    } else {
      console.log("ğŸ†• æ–°å¢å•†å“æ¨¡å¼ï¼Œåˆå§‹åŒ–ç©ºæ•°æ®");
    }

    // æ ‡è®°æ•°æ®å·²åŠ è½½å®Œæˆ
    isDataLoaded.value = true;

  } catch (error) {
    console.error("âŒ åŠ è½½å•†å“æ•°æ®å¤±è´¥:", error);
    // å¯ä»¥æ·»åŠ é”™è¯¯æç¤º
    isDataLoaded.value = true; // å³ä½¿å¤±è´¥ä¹Ÿæ ‡è®°ä¸ºå·²åŠ è½½ï¼Œé¿å…é¡µé¢å¡ä½
  }
};

// /**
//  * ä¸Šä¸€æ­¥ï¼šè¿”å›ä¸Šä¸€ä¸ªæ­¥éª¤
//  */
const handlePrevStep = (): void => {
  if (activeStep.value > 0) {
    activeStep.value--;
    console.log(`â¬…ï¸ è¿”å›ä¸Šä¸€æ­¥ï¼Œå½“å‰æ­¥éª¤: ${activeStep.value}`);
  }
};

/**
 * ä¸‹ä¸€æ­¥ï¼šè¿›å…¥ä¸‹ä¸€ä¸ªæ­¥éª¤
 */
const handleNextStep = (): void => {
  if (activeStep.value < 3) {
    activeStep.value++;
    console.log(`â¡ï¸ è¿›å…¥ä¸‹ä¸€æ­¥ï¼Œå½“å‰æ­¥éª¤: ${activeStep.value}`);
  }
};

/**
 * æ ¹æ®è·¯ç”±å‚æ•°ç¡®å®šå½“å‰æ­¥éª¤
 * ç”¨äºç›´æ¥ä»æŸä¸ªæ­¥éª¤å¼€å§‹ç¼–è¾‘
 */
const initActiveStep = (): void => {
  const step = route.query.step as string;
  if (step) {
    const stepNum = parseInt(step, 10);
    if (stepNum >= 0 && stepNum <= 3) {
      activeStep.value = stepNum;
    }
  }
};


// å¤„ç†ç¼–è¾‘å•†å“
const handleEditGoods = async (goodsId: number) => {
  console.log("ğŸ¯ çˆ¶ç»„ä»¶æ”¶åˆ°ç¼–è¾‘å•†å“è¯·æ±‚ï¼ŒID:", goodsId);

  // 1. è®¾ç½®å•†å“ID
  goodsInfo.value.id = goodsId;

  // 2. åŠ è½½å•†å“æ•°æ®
  await loadGoodsData();

  // 3. ç­‰æ•°æ®åŠ è½½å®Œæˆåï¼Œå†åˆ‡æ¢åˆ°ä¸‹ä¸€æ­¥
  console.log("â¡ï¸ å•†å“æ•°æ®åŠ è½½å®Œæˆï¼Œåˆ‡æ¢åˆ°æ­¥éª¤1");
  activeStep.value = 1;
};

// ==================== ç”Ÿå‘½å‘¨æœŸé’©å­ ====================

//æ¯æ¬¡åˆ‡æ¢å›å•†å“é¡µé¢ï¼ŒonMountedéƒ½ä¼šé‡æ–°æ‰§è¡Œï¼Œä½†æ•°æ®è¢«é‡ç½®äº†ã€‚
//onMountedåœ¨æ¯æ¬¡ç»„ä»¶æŒ‚è½½åˆ°DOMæ—¶æ‰§è¡Œã€‚å½“é¡µé¢åˆ‡æ¢æ—¶ï¼Œç»„ä»¶ä¼šè¢«é”€æ¯å’Œé‡æ–°åˆ›å»ºï¼Œæ‰€ä»¥ä¼šé‡æ–°æ‰§è¡Œã€‚
onMounted(async () => {

  console.log("ğŸ”„ å•†å“è¯¦æƒ…é¡µé¢å¼€å§‹åŠ è½½");
  console.log(`âœ… GoodsDetail é¡µé¢æ¿€æ´»`)

  // åˆå§‹åŒ–å½“å‰æ­¥éª¤
  // initActiveStep();

  // ç¡®ä¿DOMæ›´æ–°å®Œæˆ
  await nextTick();
  console.log("âœ… å•†å“è¯¦æƒ…é¡µé¢åŠ è½½å®Œæˆ");

});

onUnmounted(() => {
  console.log(`ğŸ—‘ï¸ GoodsDetail é¡µé¢é”€æ¯`)

})

// ==================== ç›‘å¬å™¨ ====================
// å¦‚æœ watchæ˜¯ä¸ºäº†ç›‘å¬ä»å…¶ä»–é¡µé¢ä¼ é€’è¿‡æ¥çš„å•†å“IDï¼Œé‚£ä¹ˆåº”è¯¥ç›‘å¬è·¯ç”±å‚æ•°ï¼Œè€Œä¸æ˜¯ç»„ä»¶å†…éƒ¨çš„æ•°æ®
// åœ¨ç°æœ‰ç›‘å¬å™¨ä¸‹é¢æ·»åŠ 
// ç›‘å¬å•†å“IDå˜åŒ–
/*é—®é¢˜ï¼šä¸ºä»€ä¹ˆä¸èƒ½é€šè¿‡è·¯ç”±ï¼Ÿ
ä½ ä»¬åœ¨åŒä¸€ä¸ªé¡µé¢å†…ï¼ˆ/pms/pms-detailï¼‰
åªæ˜¯åœ¨æ­¥éª¤é—´åˆ‡æ¢ï¼Œä¸æ˜¯é¡µé¢è·³è½¬
éœ€è¦é€šè¿‡çˆ¶å­ç»„ä»¶é€šä¿¡ä¼ é€’å•†å“ID*/
// ==================== ç›‘å¬è·¯ç”±å‚æ•°å˜åŒ– ===è¿™ä¸ªæ˜¯ä»å…¶ä»–é¡µé¢è½¬æ¢è¿‡æ¥çš„=================
// ç›‘å¬è·¯ç”±å‚æ•°ï¼ˆç”¨äºä»å…¶ä»–é¡µé¢è·³è½¬è¿‡æ¥ï¼‰
watch(() => route.params.id, async (newId, oldId) => {
  console.log("ğŸ”„ çˆ¶ç»„ä»¶ç›‘å¬åˆ°å•†å“IDå˜åŒ–:", {
    oldId,
    newId,
  });

  if (newId && newId !== oldId) {

    const goodsId = Number(newId);
    console.log("ğŸ“¦ ç›‘å¬åˆ°è·¯ç”±ä¼ é€’çš„å•†å“ID:", goodsId);
    // è¿™é‡Œå¯ä»¥è‡ªåŠ¨åŠ è½½å•†å“è¯¦æƒ…

    // è®¾ç½®å•†å“ID
    goodsInfo.value.id = goodsId;

// åŠ è½½å•†å“æ•°æ®
    await  loadGoodsData();

    // ç¼–è¾‘æ¨¡å¼é»˜è®¤è¿›å…¥æ­¥éª¤1
    if (activeStep.value === 0) {
      console.log("â¡ï¸ ç¼–è¾‘æ¨¡å¼ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æ­¥éª¤1");
      activeStep.value = 1;
    }
  } else{
    // æ–°å¢æ¨¡å¼
    console.log("ğŸ†• æ–°å¢æ¨¡å¼ï¼Œé‡ç½®æ•°æ®");
    // resetGoodsInfo();
    isDataLoaded.value = true;
  }

}, { immediate: true });





// // ç›‘å¬æ­¥éª¤å˜åŒ–ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ­¥éª¤åˆ‡æ¢æ—¶çš„é€»è¾‘
watch(activeStep, (newStep, oldStep) => {
  console.log(`ğŸ”„ æ­¥éª¤å˜åŒ–: ${oldStep} -> ${newStep}`);

  // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ­¥éª¤åˆ‡æ¢æ—¶çš„é¢å¤–é€»è¾‘
  // ä¾‹å¦‚ï¼šä¿å­˜å½“å‰æ­¥éª¤æ•°æ®ã€éªŒè¯å½“å‰æ­¥éª¤ç­‰

  // æ›´æ–°URLï¼Œæ”¯æŒç›´æ¥è·³è½¬åˆ°æŒ‡å®šæ­¥éª¤
  const currentQuery = { ...route.query };
  if (newStep === 0) {
    delete currentQuery.step;
  } else {
    currentQuery.step = newStep.toString();
  }

  router.replace({
    query: currentQuery
  }).catch(() => {});
});





//------------------------------------------------------------------------------------------------------------------------------

</script>

<style lang="scss" scoped>
.app-container {
  // è®¾ç½®æœ€å¤§å®½åº¦ï¼Œå±…ä¸­æ˜¾ç¤º
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  min-height: calc(100vh - 84px);
  background-color: #fff;
  box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
  border-radius: 8px;

  // å“åº”å¼è°ƒæ•´
  @media (max-width: 1240px) {
    max-width: 100%;
    margin: 0 20px;
  }

  @media (max-width: 768px) {
    margin: 0 10px;
    padding: 15px;
  }
}

// æ­¥éª¤æ¡æ ·å¼
.goods-steps {
  margin-bottom: 40px;
  padding: 20px;
  background-color: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #ebeef5;

  :deep(.el-step) {
    .el-step__title {
      font-size: 16px;
      font-weight: 500;
    }

    .el-step__description {
      font-size: 12px;
      color: #909399;
      margin-top: 4px;
    }

    // æ¿€æ´»æ­¥éª¤çš„æ ·å¼
    &.is-process {
      .el-step__title {
        color: #409eff;
        font-weight: 600;
      }
    }

    // å®Œæˆæ­¥éª¤çš„æ ·å¼
    &.is-success {
      .el-step__title {
        color: #67c23a;
      }

      .el-step__icon {
        background-color: #67c23a;
        border-color: #67c23a;
      }
    }
  }

  // å“åº”å¼è°ƒæ•´
  @media (max-width: 768px) {
    padding: 15px 10px;
    margin-bottom: 30px;

    :deep(.el-step) {
      .el-step__title {
        font-size: 14px;
      }

      .el-step__description {
        display: none; // å°å±å¹•éšè—æè¿°
      }
    }
  }

  @media (max-width: 480px) {
    :deep(.el-step) {
      .el-step__title {
        font-size: 12px;
      }
    }
  }
}

// æ­¥éª¤å†…å®¹å®¹å™¨
:deep(.step-content) {
  animation: fadeIn 0.3s ease-in-out;

  // æ¯ä¸ªæ­¥éª¤å†…å®¹çš„ç»Ÿä¸€æ ·å¼
  .step-content-inner {
    padding: 30px;
    background-color: #fff;
    border-radius: 8px;
    border: 1px solid #ebeef5;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);

    @media (max-width: 768px) {
      padding: 20px 15px;
    }
  }

  // æ­¥éª¤æ“ä½œæŒ‰é’®åŒºåŸŸ
  .step-actions {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #ebeef5;
    text-align: center;

    .el-button {
      min-width: 100px;
      margin: 0 10px;

      &:first-child {
        margin-left: 0;
      }

      &:last-child {
        margin-right: 0;
      }
    }

    @media (max-width: 768px) {
      margin-top: 20px;
      padding-top: 15px;

      .el-button {
        width: 100%;
        margin: 5px 0;
      }
    }
  }
}

// æ·¡å…¥åŠ¨ç”»
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

// åŠ è½½çŠ¶æ€
.loading-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 400px;

  .loading-text {
    margin-left: 10px;
    color: #409eff;
    font-size: 16px;
  }
}

// é”™è¯¯çŠ¶æ€
.error-container {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-height: 400px;
  text-align: center;

  .error-icon {
    font-size: 60px;
    color: #f56c6c;
    margin-bottom: 20px;
  }

  .error-text {
    color: #f56c6c;
    font-size: 18px;
    margin-bottom: 20px;
  }

  .retry-button {
    min-width: 120px;
  }
}
</style>
